<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Smart Contract Proxies - A Deep Dive</h1><p class="page-description">The only resource you will ever need for all your proxy related queries.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-02-12T00:00:00-06:00" itemprop="datePublished">
        Feb 12, 2023
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#defi">defi</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#diamond">diamond</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#beacon">beacon</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#UUPS">UUPS</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#web3">web3</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#proxies">proxies</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#proxy">proxy</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#upgradable-contracts">upgradable-contracts</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#types-of-proxies">Types of Proxies</a>
<ul>
<li class="toc-entry toc-h2"><a href="#minimal-proxy-pattern">Minimal Proxy Pattern</a>
<ul>
<li class="toc-entry toc-h3"><a href="#problem-statement">Problem Statement</a></li>
<li class="toc-entry toc-h3"><a href="#solution">Solution</a>
<ul>
<li class="toc-entry toc-h4"><a href="#sequence-for-this-pattern">Sequence for this pattern</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#pre-requisites">Pre-Requisites</a>
<ul>
<li class="toc-entry toc-h2"><a href="#1-delegatecall">1. delegatecall</a>
<ul>
<li class="toc-entry toc-h3"><a href="#1-do-not-delegatecall-to-an-untrusted-contract">1. Do not delegatecall to an untrusted contract</a></li>
<li class="toc-entry toc-h3"><a href="#2-use-delegatecall-only-on-contracts">2. Use delegatecall only on contracts</a></li>
<li class="toc-entry toc-h3"><a href="#3-managing-state-variable-layout">3. Managing State Variable Layout</a>
<ul>
<li class="toc-entry toc-h4"><a href="#31-inherited-storage">3.1 Inherited Storage</a></li>
<li class="toc-entry toc-h4"><a href="#32-diamond-storage">3.2 Diamond Storage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#resources-consulted">Resources Consulted</a></li>
</ul><h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>For a primer on all things you <strong>MUST</strong> understand before going ahead with learning about proxies in depth, please navigate to the end of this article, find the section named <strong>Pre-Requisites</strong> and make sure you understand all concepts listed there.</p>

<p>I did a short article on proxies sometime back, but it was really basic and surface-level. If you want, you can read that <a href="https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html">here</a>.</p>

<p>All proxy patterns are linked together by a distinct feature. It is the combination of <strong><code class="language-plaintext highlighter-rouge">delegatecall</code> along with the <code class="language-plaintext highlighter-rouge">fallback</code> function</strong>.</p>

<h1 id="types-of-proxies">
<a class="anchor" href="#types-of-proxies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Types of Proxies</h1>

<p>Different proxy patterns came up to solve different(or incremental) problems related to gas cost efficiency, security and upgradability. Let’s have a look at the different kinds of proxies out there.</p>

<h2 id="minimal-proxy-pattern">
<a class="anchor" href="#minimal-proxy-pattern" aria-hidden="true"><span class="octicon octicon-link"></span></a>Minimal Proxy Pattern</h2>

<h3 id="problem-statement">
<a class="anchor" href="#problem-statement" aria-hidden="true"><span class="octicon octicon-link"></span></a>Problem Statement</h3>

<p>How to repeatedly deploy the same contract with minimum gas cost? For example, if I have a wallet contract and for every user I want to deploy a new smart contract representing that particular user’s wallet (with the same logic implementation), how do I do that in the most gas-efficient manner?</p>

<h3 id="solution">
<a class="anchor" href="#solution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Solution</h3>

<p>Instead of sending the bytecode for the (repeated) contract over and over again to the blockchain for deployment, we create a <code class="language-plaintext highlighter-rouge">minimal contract</code> which simply references a <code class="language-plaintext highlighter-rouge">boilerplate</code> contract (the logic implementation contract) and redirects <code class="language-plaintext highlighter-rouge">calls</code> from the users to the <code class="language-plaintext highlighter-rouge">boilerplate</code> contract via <code class="language-plaintext highlighter-rouge">delegatecalls</code>.</p>

<h4 id="sequence-for-this-pattern">
<a class="anchor" href="#sequence-for-this-pattern" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sequence for this pattern</h4>

<p>(user) <code class="language-plaintext highlighter-rouge">call</code> —&gt; (in the minimal contract) <code class="language-plaintext highlighter-rouge">fallback</code> —&gt; (from minimal contract to implementation contract) <code class="language-plaintext highlighter-rouge">delegatecall</code> —&gt; (implementation contract invocation of) target Function()</p>

<blockquote>
  <p>Official reading material: <a href="https://eips.ethereum.org/EIPS/eip-1167">EIP 1167</a>.</p>
</blockquote>

<h1 id="pre-requisites">
<a class="anchor" href="#pre-requisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pre-Requisites</h1>

<p>This section contains all concepts you must be aware of, to gain a comprehensive understanding of different proxy patterns.</p>

<h2 id="1-delegatecall">
<a class="anchor" href="#1-delegatecall" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. <code class="language-plaintext highlighter-rouge">delegatecall</code>
</h2>

<p>If a contract A calls a function in Contract B via <code class="language-plaintext highlighter-rouge">delegatecall</code>, then the function from contract B is executed with the context provided by contract A.</p>

<p>That means, only the function logic is borrowed from contract B, other things such as <code class="language-plaintext highlighter-rouge">address(this)</code>, <code class="language-plaintext highlighter-rouge">msg.sender</code> and <code class="language-plaintext highlighter-rouge">msg.value</code> do not change.</p>

<p>No change in the state variables of contract B is noticed. For example, let’s consider the following code snippet.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">contract</span> <span class="n">A</span> <span class="p">{</span>

    <span class="kt">string</span> <span class="k">internal</span> <span class="n">tokenName</span> <span class="o">=</span> <span class="s">"FunToken"</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">changeTokenNameWithFunctionLogicFromContractB</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">contractBAddress</span> <span class="o">=</span> <span class="mh">0xb27A31f1b0AF2946B7F582768f03239b1eC07c2c</span><span class="p">;</span> <span class="c1">// Assume this is the address of the deployed contract B.
</span>        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">returnData</span><span class="p">)</span> <span class="o">=</span> <span class="n">contractBAddress</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">contractB</span><span class="p">.</span><span class="n">setTokenName</span><span class="p">.</span><span class="nb">selector</span><span class="p">,</span> <span class="s">"BoringToken"</span><span class="p">));</span>

        <span class="c1">// This is one big logic block to get the reason of revert of the `delegatecall` since, the reason is not returned by default.
</span>        <span class="k">if</span><span class="p">(</span><span class="n">success</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">returnData</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">assembly</span> <span class="p">{</span>
                    <span class="kr">let</span> <span class="n">returndata_size</span> <span class="o">:=</span> <span class="n">mload</span><span class="p">(</span><span class="n">returndata</span><span class="p">)</span>
                    <span class="nb">revert</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">returndata</span><span class="p">),</span> <span class="n">returndata_size</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nb">revert</span><span class="p">(</span><span class="s">"delegatecall reverted"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContractATokenName</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">tokenName</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">contract</span> <span class="n">B</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="k">internal</span> <span class="n">tokenName</span> <span class="o">=</span> <span class="s">"TokenB"</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">setTokenName</span><span class="p">(</span><span class="kt">string</span> <span class="k">calldata</span> <span class="n">_newName</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">tokenName</span> <span class="o">=</span> <span class="n">_newName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContractBTokenName</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">tokenName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Here, when you call the function <code class="language-plaintext highlighter-rouge">changeTokenNameWithFunctionLogicFromContractB</code>, the value of the <code class="language-plaintext highlighter-rouge">tokenName</code> variable in contract A changes to <code class="language-plaintext highlighter-rouge">BoringToken</code> while the <code class="language-plaintext highlighter-rouge">tokenName</code> variable of contract B remains <code class="language-plaintext highlighter-rouge">TokenB</code>.</p>

<p>This is the usecase and power of <code class="language-plaintext highlighter-rouge">delegatecall</code>.</p>

<h3 id="1-do-not-delegatecall-to-an-untrusted-contract">
<a class="anchor" href="#1-do-not-delegatecall-to-an-untrusted-contract" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Do not <code class="language-plaintext highlighter-rouge">delegatecall</code> to an untrusted contract</h3>

<p>If the contract that you <code class="language-plaintext highlighter-rouge">delegatecall</code> to, executes <code class="language-plaintext highlighter-rouge">selfdestruct</code>, then your contract itself gets completely deleted from the blockchain. This is less than ideal in most cases.</p>

<p>Here’s an example:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">OneWhoDelegates</span> <span class="p">{</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_attacker</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oneWhoIsDelegatedTo</span> <span class="o">=</span> <span class="n">_attacker</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getBTCPriceFromOracle</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">returnData</span><span class="p">)</span> <span class="o">=</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span>
            <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">OneWhoIsDelegatedTo</span><span class="p">.</span><span class="n">fetchBTCPriceLatest</span><span class="p">.</span><span class="nb">selector</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">returnData</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">giveMeSomeEther</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span> <span class="c1">// This function is used to make 
</span>                        <span class="c1">// sure that this contract has some Ether in the first place
</span><span class="p">}</span>

<span class="k">contract</span> <span class="n">OneWhoIsDelegatedTo</span> <span class="p">{</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">oracleContract</span><span class="p">;</span>
    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// This function was hidden away in some distinct file
</span>    <span class="k">function</span> <span class="n">_fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">private</span> <span class="p">{</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">oracleContract</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_fetchBTCPriceLatest</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the above contract, if the contract <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code> calls <code class="language-plaintext highlighter-rouge">getBTCPriceFromOracle</code>, then the contract <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code> would be deleted from the blockchain and the ether inside of that contract would be transferred to the contract <code class="language-plaintext highlighter-rouge">OneWhoIsDelegatedTo</code>.</p>

<p>So, make sure all your <code class="language-plaintext highlighter-rouge">delegatecalls</code> are to trusted contracts and be extra careful incase those contracts that you are delegating to, are upgradable.</p>

<h3 id="2-use-delegatecall-only-on-contracts">
<a class="anchor" href="#2-use-delegatecall-only-on-contracts" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Use <code class="language-plaintext highlighter-rouge">delegatecall</code> only on contracts</h3>

<p>Since <code class="language-plaintext highlighter-rouge">delegatecall</code> is a low level call, it will always return <code class="language-plaintext highlighter-rouge">true</code> if the call(<code class="language-plaintext highlighter-rouge">delegatecall</code>) is made to a contract/function that does not exist. Therefore, we must always make sure that the address that we are using <code class="language-plaintext highlighter-rouge">delegatecall</code> on must be contract.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">OneWhoDelegates</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="k">public</span> <span class="n">deployerEOA</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="k">internal</span> <span class="n">_fundsWithdrawable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">deployerEOA</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkIfFundsAreWithdrawable</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">priceOracleContractAddress</span> <span class="o">=</span> <span class="n">deployerEOA</span><span class="p">;</span> <span class="c1">// This was done due to some misunderstanding
</span>        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">priceOracleContractAddress</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">OneWhoIsDelegatedTo</span><span class="p">.</span><span class="n">isFundWithdrawable</span><span class="p">.</span><span class="nb">selector</span><span class="p">));</span>
        <span class="n">_fundsWithdrawable</span> <span class="o">=</span> <span class="n">success</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fundsWithdrawable</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">contract</span> <span class="n">OneWhoIsDelegatedTo</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">isFundWithdrawable</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this contract, there is simply no way that <code class="language-plaintext highlighter-rouge">_fundsWithdrawable</code> can remain <code class="language-plaintext highlighter-rouge">false</code> if <code class="language-plaintext highlighter-rouge">checkIfFundsAreWithdrawable</code> even once since it will always return <code class="language-plaintext highlighter-rouge">true</code> and set <code class="language-plaintext highlighter-rouge">_fundsWithdrawable</code> to true.</p>

<p>We can always use the following code snippet to check if a given address is indeed a contract with some code.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">function</span> <span class="n">checkIfFundsAreWithdrawable</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">priceOracleContractAddress</span> <span class="o">=</span> <span class="n">deployerEOA</span><span class="p">;</span> <span class="c1">// This was done due to some misunderstanding
</span>        <span class="k">if</span><span class="p">(</span><span class="n">isContract</span><span class="p">(</span><span class="n">priceOracleContractAddress</span><span class="p">))</span> <span class="p">{</span>
            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">priceOracleContractAddress</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">OneWhoIsDelegatedTo</span><span class="p">.</span><span class="n">isFundWithdrawable</span><span class="p">.</span><span class="nb">selector</span><span class="p">));</span>
            <span class="n">_fundsWithdrawable</span> <span class="o">=</span> <span class="n">success</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">_fundsWithdrawable</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">revert</span><span class="p">(</span><span class="s">"Price Oracle contract address not set correctly"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">isContract</span><span class="p">(</span><span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">contractSize</span><span class="p">;</span>
        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">contractSize</span> <span class="o">:=</span> <span class="n">extcodesize</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">contractSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="3-managing-state-variable-layout">
<a class="anchor" href="#3-managing-state-variable-layout" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Managing State Variable Layout</h3>

<p>Since contractB is called in the context of contractA, therefore both of these contracts must have the same state variable layout, implying, that the same state variables are declared in the same order in both contracts.</p>

<p>For example, consider the following code snippet:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">OneWhoDelegates</span> <span class="p">{</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_attacker</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oneWhoIsDelegatedTo</span> <span class="o">=</span> <span class="n">_attacker</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getBTCPriceFromOracle</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">returnData</span><span class="p">)</span> <span class="o">=</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span>
            <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">OneWhoIsDelegatedTo</span><span class="p">.</span><span class="n">fetchBTCPriceLatest</span><span class="p">.</span><span class="nb">selector</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">returnData</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">giveMeSomeEther</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span> <span class="c1">// This function is used to make 
</span>                        <span class="c1">// sure that this contract has some Ether in the first place
</span><span class="p">}</span>

<span class="k">contract</span> <span class="n">OneWhoIsDelegatedTo</span> <span class="p">{</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// This function was hidden away in some distinct file
</span>    <span class="k">function</span> <span class="n">_fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">private</span> <span class="p">{</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">owner</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_fetchBTCPriceLatest</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here in this code snippet, once <code class="language-plaintext highlighter-rouge">selfdestruct</code> is called via <code class="language-plaintext highlighter-rouge">fetchBTCPriceLatest()</code>, the stored ether in contract <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code> should have gone to the address <code class="language-plaintext highlighter-rouge">_owner</code> as mentioned in the parameter of <code class="language-plaintext highlighter-rouge">selfdestruct</code>. However, if you run this code, you will notice that the Ether from contract <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code> is transferred to the contract <code class="language-plaintext highlighter-rouge">OneWhoIsDelegatedTo</code>. This is because, at the place the <code class="language-plaintext highlighter-rouge">_owner</code> address is declared in contract <code class="language-plaintext highlighter-rouge">OneWhoIsDelegatedTo</code>, in the contract <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code> at the same place the contract address of <code class="language-plaintext highlighter-rouge">OneWhoIsDelegatedTo</code> is stored and since <code class="language-plaintext highlighter-rouge">deleagatecall</code> ran <code class="language-plaintext highlighter-rouge">selfdestruct</code> in the context of <code class="language-plaintext highlighter-rouge">OneWhoDelegates</code>, the Ether was transferred to the address <code class="language-plaintext highlighter-rouge">oneWhoIsDelegatedTo</code> instead of address <code class="language-plaintext highlighter-rouge">_owner</code>.</p>

<p>Now, let’s see a few ways in which we manage the <strong>State Variable Layout</strong> :</p>

<h4 id="31-inherited-storage">
<a class="anchor" href="#31-inherited-storage" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.1 Inherited Storage</h4>

<p>All contracts who indulge in this <code class="language-plaintext highlighter-rouge">delegatecall</code> circus, inherit their state variables from a central <code class="language-plaintext highlighter-rouge">storage</code> contract which declares all the state variables used in all the contracts.</p>

<p>Limitations:</p>
<ol>
  <li>Local variable/function names can overshadow pre-existing storage variable names from the parent contract.</li>
  <li>Reduces the composabilty of all contracts inheriting from the main contract. (Composability =&gt; Ability to work with other smart contracts)</li>
</ol>

<h4 id="32-diamond-storage">
<a class="anchor" href="#32-diamond-storage" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.2 Diamond Storage</h4>

<p>If we stop relying on Solidity’s default storage memory allocation, then there is no need to have the same storage layout structure. We can specify where to start storing data in the address space. For different contracts we can specify different locations to start storing data, therefore preventing different contracts with different state variables from clashing storage locations. This is what Diamond Storage does.</p>

<p>We can hash a unique string to get a random storage position and store a struct there. The struct can contain all the state variables that we want. The unique string can act like a namespace for particular functionality.</p>

<p>Let’s understand this <code class="language-plaintext highlighter-rouge">diamond storage</code> concept with an example:</p>

<p><strong>THIS EXAMPLE NEEDS MORE WORK. DO NOT FOLLOW THIS RIGHT NOW</strong></p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">library</span> <span class="n">DiamondStorage</span> <span class="p">{</span>
  <span class="kt">bytes32</span> <span class="k">constant</span> <span class="n">ONE_WHO_DELEGATES_STRUCT_POSITION</span> <span class="o">=</span> 
    <span class="nb">keccak256</span><span class="p">(</span><span class="s">"saxenism.delegatecall_diamond_storage_article.one_who_delegates_struct"</span><span class="p">);</span>

  <span class="kt">bytes32</span> <span class="k">constant</span> <span class="n">ONE_WHO_IS_DELEGATED_TO_STRUCT_POSITION</span> <span class="o">=</span> 
    <span class="nb">keccak256</span><span class="p">(</span><span class="s">"saxenism.delegatecall_diamond_storage_article.one_who_is_delegated_to_struct"</span><span class="p">);</span>

  <span class="k">struct</span> <span class="n">OneWhoDelegatesStruct</span> <span class="p">{</span>
      <span class="kt">address</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="n">OneWhoIsDelegatedToStruct</span> <span class="p">{</span>
      <span class="kt">address</span> <span class="n">owner</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">oneWhoDelegatesStructStorage</span><span class="p">()</span>
    <span class="k">internal</span> 
    <span class="k">pure</span> 
    <span class="k">returns</span> <span class="p">(</span><span class="n">OneWhoDelegatesStruct</span> <span class="k">storage</span> <span class="n">oneWhoDelegatesStruct</span><span class="p">)</span> 
  <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">position</span> <span class="o">=</span> <span class="n">ONE_WHO_DELEGATES_STRUCT_POSITION</span><span class="p">;</span>
    <span class="k">assembly</span> <span class="p">{</span>
      <span class="n">oneWhoDelegatesStruct</span><span class="p">.</span><span class="n">slot</span> <span class="o">:=</span> <span class="n">position</span>
    <span class="p">}</span>
  <span class="p">}</span>

    <span class="k">function</span> <span class="n">oneWhoIsDelegatedToStructStorage</span><span class="p">()</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span><span class="p">(</span><span class="n">OneWhoIsDelegatedToStruct</span> <span class="k">storage</span> <span class="n">oneWhoIsDelegatedToStruct</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">position</span> <span class="o">=</span> <span class="n">ONE_WHO_IS_DELEGATED_TO_STRUCT_POSITION</span><span class="p">;</span>
        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">oneWhoIsDelegatedToStruct</span><span class="p">.</span><span class="n">slot</span> <span class="o">:=</span> <span class="n">position</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">contract</span> <span class="n">OneWhoDelegates</span> <span class="p">{</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_attacker</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oneWhoIsDelegatedTo</span> <span class="o">=</span> <span class="n">_attacker</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getBTCPriceFromOracle</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">returnData</span><span class="p">)</span> <span class="o">=</span> <span class="n">oneWhoIsDelegatedTo</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span>
            <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span><span class="n">OneWhoIsDelegatedTo</span><span class="p">.</span><span class="n">fetchBTCPriceLatest</span><span class="p">.</span><span class="nb">selector</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">returnData</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">giveMeSomeEther</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span> <span class="c1">// This function is used to make 
</span>                        <span class="c1">// sure that this contract has some Ether in the first place
</span><span class="p">}</span>

<span class="k">contract</span> <span class="n">OneWhoIsDelegatedTo</span> <span class="p">{</span>

    <span class="n">DiamondStorage</span><span class="p">.</span><span class="n">OneWhoIsDelegatedToStruct</span> <span class="n">delegateeStruct</span> <span class="o">=</span> <span class="n">DiamondStorage</span><span class="p">.</span><span class="n">oneWhoIsDelegatedToStructStorage</span><span class="p">();</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">delegateeStruct</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// This function was hidden away in some distinct file
</span>    <span class="k">function</span> <span class="n">_fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">private</span> <span class="p">{</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">delegateeStruct</span><span class="p">.</span><span class="n">owner</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">fetchBTCPriceLatest</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_fetchBTCPriceLatest</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="resources-consulted">
<a class="anchor" href="#resources-consulted" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources Consulted</h1>

<ol>
  <li><a href="https://www.youtube.com/watch?v=iXLoSVcVhUg">Felix’s EVM Expedition: Proxies, Beacons and Diamond Pattern</a></li>
  <li><a href="https://eip2535diamonds.substack.com/p/understanding-delegatecall-and-how">Nick Mudge’s Substack: Understanding delegatecall And How to Use It Safely</a></li>
</ol>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="saxenism/saxenism-expressions"
        issue-term="title"
        label="blogpost-comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://saxenism.com/defi/diamond/beacon/uups/web3/proxies/proxy/upgradable-contracts/2023/02/12/Proxies-Deep-Dive.html';
      this.page.identifier = 'https://saxenism.com/defi/diamond/beacon/uups/web3/proxies/proxy/upgradable-contracts/2023/02/12/Proxies-Deep-Dive.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/defi/diamond/beacon/uups/web3/proxies/proxy/upgradable-contracts/2023/02/12/Proxies-Deep-Dive.html" hidden></a>
</article>
