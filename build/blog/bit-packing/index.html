<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Solidity - Bit Packing | Gm!! I am Rahul Saxena</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://saxenism.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://saxenism.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://saxenism.com/blog/bit-packing"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Solidity - Bit Packing | Gm!! I am Rahul Saxena"><meta data-rh="true" name="description" content="My last blog post about Bit Magic generated some buzz amongst fellow EVM developers and some of them reached out to me to include additional things in my blog related to using bits effectively in Solidity and the EVM in general."><meta data-rh="true" property="og:description" content="My last blog post about Bit Magic generated some buzz amongst fellow EVM developers and some of them reached out to me to include additional things in my blog related to using bits effectively in Solidity and the EVM in general."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-10-09T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://twitter.com/saxenism"><meta data-rh="true" property="article:tag" content="web3,solidity,language-tricks,bit-magic,bit-packing,intermediate"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://saxenism.com/blog/bit-packing"><link data-rh="true" rel="alternate" href="https://saxenism.com/blog/bit-packing" hreflang="en"><link data-rh="true" rel="alternate" href="https://saxenism.com/blog/bit-packing" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Gm!! I am Rahul Saxena RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Gm!! I am Rahul Saxena Atom Feed"><link rel="stylesheet" href="/assets/css/styles.270a00ce.css">
<link rel="preload" href="/assets/js/runtime~main.90562e27.js" as="script">
<link rel="preload" href="/assets/js/main.5c1f9dfc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/videos">Videos</a><a class="navbar__item navbar__link" href="/testimonials">Testimonials</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/bit-packing">Solidity - Bit Packing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/functions-as-params">Solidity - Passing functions as parameters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mdx-blog-post">MDX Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/long-blog-post">Long Blog Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Solidity - Bit Packing</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-10-09T00:00:00.000Z" itemprop="datePublished">October 9, 2022</time> Â· <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/saxenism" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg" alt="Rahul Saxena"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/saxenism" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Rahul Saxena</span></a></div><small class="avatar__subtitle" itemprop="description">EVM Enjoyoor</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>My last blog post about <a href="https://saxenism.com/web3/solidity/language-tricks/bit-magic/intermediate/2022/09/06/Bit-Magic-Solidity.html" target="_blank" rel="noopener noreferrer">Bit Magic</a> generated some buzz amongst fellow EVM developers and some of them reached out to me to include additional things in my blog related to using bits effectively in Solidity and the EVM in general.</p><p>One such dev was the giga-chad maintainer of ERC721A himself, <a href="https://twitter.com/optimizoor" target="_blank" rel="noopener noreferrer">Vectorized.eth</a> and he shared <a href="https://twitter.com/optimizoor/status/1526015118479200256" target="_blank" rel="noopener noreferrer">a tweet</a> with me where he showed a few code snippets where some really cool things were going on.</p><p>Unfortunately, I could not make much sense out of it from the snippets and I had to head over to the <a href="https://github.com/chiru-labs/ERC721A/pull/272" target="_blank" rel="noopener noreferrer">ERC721A pull request</a> that was behind the tweet and at that time my world turned upside down.</p><p>The <a href="https://github.com/chiru-labs" target="_blank" rel="noopener noreferrer">Chiru Labs</a> team had written some incredible code and while I have not (yet) figured everything happening in the contract, I did understand that the essence of the contract/PR was to use <em>uint packing</em> instead of <em>structs</em>.</p><p>So, I set out to write some code for myself and figure out how struct can be packed into uints and see if that could lead to any gas savings. So, let me present my finding.</p><p><strong>Spoiler Alert</strong> <br>
Yes, it was possible. <br>
Yes, it did save gas. <br>
Yes, I did love it. <br></p><h1>Pitfalls</h1><p>First of all, to proceed ahead with this article, you need to know what the <em>left shift operator</em> is, what the <em>right shift operator</em> and what is it that they do. Apart from that, you should also understand bitwise operations such as <code>&amp;</code> , <code>|</code>, <code>~</code> ,etc.</p><p>A good place to learn these concepts or revisit them is <a href="https://www.geeksforgeeks.org/bitwise-operators-in-c-cpp/" target="_blank" rel="noopener noreferrer">this gfg blog</a>.</p><p>Next is the biggest pitfall of all. This is where I tripped hard and my mind almost broke (since I could not make sense of the ERC721A contract). Since, most of us might have native languages where we read that language from left to right you would naturally expect Solidity to also have the first stored data on the leftmost end and last saved data on the rightmost end. </p><p><em>BUT BUT BUT</em></p><p>That is not the case. Basically, if you were to store four numbers A,B,C and D in that order, inside of a word you would expect that word to look like this: <!-- -->[A,B,C,D]<!-- --> but they would be stored as <!-- -->[D,C,B,A]<!-- -->. </p><p>(Slightly relevant: ) A good primer about Endianess can be found in <a href="https://www.freecodecamp.org/news/what-is-endianness-big-endian-vs-little-endian/" target="_blank" rel="noopener noreferrer">this freecodecamp article</a>.</p><p>Let me illustrate this point with <a href="https://gateway.pinata.cloud/ipfs/QmZvGzhf9o6j837xF7eYLnufEACDa2MEvG8qh9TRz3k7bv" target="_blank" rel="noopener noreferrer">a picture</a>:</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/32522659/194752317-bfb99eeb-f452-4991-99ff-df6c6b9ba102.jpeg" alt="Big/Little Endian Explanation" class="img_ev3q"></p><h1>Onto the code</h1><p>Now that we have established our motivation, our objectives and are aware of the common pitfalls, time to relish the sweet code that we all had been waiting for.</p><p>The code is pretty self-explainatory and comments are put where needed. No more explanation is required.</p><p>Also, the Harry Potter theme of this contract was inspired by a <a href="https://twitter.com/longestwavelen/status/1578620950479659008?s=20&amp;t=u42okhhEbNKXrWgyorA8NA" target="_blank" rel="noopener noreferrer">silly tweet</a>. Lol :P</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// SPDX-License-Identifier: Unlicensed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*******</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Here are some addresses that you can use for dry-run if you want to the run the contract in Remix.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address public SiriusBlack = 0xdD870fA1b7C4700F2BD7f44238821C26f7392148; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address public RubeusHagrid = 0x14723A09ACff6D2A60DcdF7aA4AFf308FDDC160C;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address public BellatrixLestrange = 0x4B0897b0513fdC7C541B6d9D7E929C4e5364D2dB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address public SeverusSnape = 0x583031D1113aD414F02576BD6afaBfb302140225;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">********/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pragma solidity 0.8.17;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract BitPackingAlpha {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// A little definitions here and there so the meat of our code looks slick</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint private constant POTIONS_POSITION = 64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint private constant TRANSFIGURATION_POSITION = 128;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint private constant CARE_OF_MAGICAL_CREATURES_POSITION = 192;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint private constant SINGLE_SUBJECT_MASK = (1 &lt;&lt; 64) - 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint private constant MASK_EVERYTHING_BUT_CARE_OF_MAGICAL_CREATURES = (1 &lt;&lt; 192) - 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address serDumbledore;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serDumbledore = msg.sender;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // These separate mappings are to separate the effect of calling normal functions and bit magic functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping (address =&gt; bool) private _studentGraded;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping (address =&gt; bool) private _studentGradedBitMagic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping (address =&gt; ScoreCard) private results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping (address =&gt; uint256) private bitMagicResults;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Only Dumbledore can grade students</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier onlyHeadmaster() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(msg.sender == serDumbledore, &quot;Only the headmaster can do this action&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The students can only be graded once</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier graded(address _student) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(!_studentGraded[_student], &quot;Student has already been graded&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier gradedBitMagic(address _student) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(!_studentGradedBitMagic[_student], &quot;Student has already been graded&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// This is how we would (and probably should) do things normally. The way of the normie.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Each of these subjects can only be graded from 0 to 100.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct ScoreCard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint defenceAgainstTheDarkArts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint potions;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint transfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint careOfMagicalCreatures;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execution Cost: 139811</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The grades for each of the four subjects are generated randomly and then stored in the *results* mapping against the address of the particular _student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function gradeStudents(address _student) public onlyHeadmaster graded(_student) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint datda_score = uint(keccak256(abi.encodePacked(_student, &quot;defenceAgainstTheDarkArts&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint potions_score = uint(keccak256(abi.encodePacked(_student, &quot;potions&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint transfiguration_score = uint(keccak256(abi.encodePacked(_student, &quot;transfiguration&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint comc_score = uint(keccak256(abi.encodePacked(_student, &quot;careOfMagicalCreatures&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results[_student] = ScoreCard(datda_score, potions_score, transfiguration_score, comc_score);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _studentGraded[_student] = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execution Cost: 31229</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Grab the results of student with address _student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getStudentResults(address _student) external view returns(uint, uint, uint, uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results[_student].defenceAgainstTheDarkArts, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results[_student].potions,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results[_student].transfiguration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results[_student].careOfMagicalCreatures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Let&#x27;s try some bit magic now. The way of the Bit Magician (Frankly it&#x27;s just bit packing. Nothing fancy :P)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Takes four 8 bytes uints and pack it into a single uint256 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Initialize a number `packedMarksUint` which has 256 0&#x27;s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Take the number that you want to pack, shift it to its required place(0th bit, 64th bit, 128th bit or the 192nd bit) and do an OR with the 64 0&#x27;s at that place of the `packedMarksUint` uint.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function packMarksIntoASingleUint(uint a, uint b, uint c, uint d) private pure returns (uint packedResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint packedMarksUint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        packedMarksUint = packedMarksUint | uint64(a); // This stores the Defence Against the Dark Arts grades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        packedMarksUint = packedMarksUint | (b &lt;&lt; POTIONS_POSITION); // This stores the Potions grade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        packedMarksUint = packedMarksUint | (c &lt;&lt; TRANSFIGURATION_POSITION); // This stores the Transfiguration grades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        packedMarksUint = (packedMarksUint &amp; MASK_EVERYTHING_BUT_CARE_OF_MAGICAL_CREATURES) | (d &lt;&lt; CARE_OF_MAGICAL_CREATURES_POSITION); // This stores the Care of Magical Creatures grades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        packedResult = packedMarksUint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execution Cost: 25229</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Logic is to shift the target number to the leftmost end and then do an *&amp;* with 64 1&#x27;s to reveal that particular number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // For the rightmost number, we only need to shift it to the leftmost position and cast it to uint64. That does the same thing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getStudentResultsBitMagic(address _student) external view returns (uint _datda, uint _potions, uint _transfigurations, uint64 _comc) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _datda = (bitMagicResults[_student] &amp; SINGLE_SUBJECT_MASK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _potions = ((bitMagicResults[_student] &gt;&gt; POTIONS_POSITION) &amp; SINGLE_SUBJECT_MASK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _transfigurations = ((bitMagicResults[_student] &gt;&gt; TRANSFIGURATION_POSITION) &amp; SINGLE_SUBJECT_MASK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _comc = uint64(bitMagicResults[_student] &gt;&gt; CARE_OF_MAGICAL_CREATURES_POSITION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execution Cost: 73430 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The grades for each of the four subjects are generated randomly and then stored as a packed uint256 in the *bitMagicResults* mapping against the address of the particular _student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function gradeStudentsWithBitMagic(address _student) external onlyHeadmaster gradedBitMagic(_student) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint datda_score = uint(keccak256(abi.encodePacked(_student, &quot;defenceAgainstTheDarkArts&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint potions_score = uint(keccak256(abi.encodePacked(_student, &quot;potions&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint transfiguration_score = uint(keccak256(abi.encodePacked(_student, &quot;transfiguration&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint comc_score = uint(keccak256(abi.encodePacked(_student, &quot;careOfMagicalCreatures&quot;, block.difficulty, block.timestamp))) % 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bitMagicResults[_student] = packMarksIntoASingleUint(datda_score, potions_score, transfiguration_score, comc_score);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _studentGradedBitMagic[_student] = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Viewing individual grades (I simply combined all these function logics in the function getStudentResultsBitMagic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function bitMagicGetDefenceAgainstTheDarkArtsGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (bitMagicResults[_student] &amp; ((1 &lt;&lt; 64) - 1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function bitMagicGetCareOfMagicalCreaturesGrades(address _student) external view returns (uint64) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return uint64(bitMagicResults[_student] &gt;&gt; CARE_OF_MAGICAL_CREATURES_POSITION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function bitMagicGetPotionsGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((bitMagicResults[_student] &gt;&gt; POTIONS_POSITION) &amp; SINGLE_SUBJECT_MASK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function bitMagicGetTransfigurationGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((bitMagicResults[_student] &gt;&gt; TRANSFIGURATION_POSITION) &amp; SINGLE_SUBJECT_MASK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Viewing individual grades: The normie way</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getDefenceAgainstTheDarkArtsGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results[_student].defenceAgainstTheDarkArts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getPotionsGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results[_student].potions;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getTransfigurationGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results[_student].transfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function getCareOfMagicalCreaturesGrades(address _student) external view returns (uint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results[_student].careOfMagicalCreatures;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/web-3">web3</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/solidity">solidity</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/language-tricks">language-tricks</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bit-magic">bit-magic</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bit-packing">bit-packing</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/intermediate">intermediate</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-10-09-Bit-Packing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/functions-as-params"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Solidity - Passing functions as parameters</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.90562e27.js"></script>
<script src="/assets/js/main.5c1f9dfc.js"></script>
</body>
</html>