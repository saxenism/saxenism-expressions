"use strict";(self.webpackChunksaxenism_personal_website=self.webpackChunksaxenism_personal_website||[]).push([[3982],{3905:(t,e,n)=>{n.d(e,{Zo:()=>c,kt:()=>h});var a=n(7294);function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function s(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,i=function(t,e){if(null==t)return{};var n,a,i={},r=Object.keys(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var d=a.createContext({}),u=function(t){var e=a.useContext(d),n=e;return t&&(n="function"==typeof t?t(e):s(s({},e),t)),n},c=function(t){var e=u(t.components);return a.createElement(d.Provider,{value:e},t.children)},l="mdxType",p={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},g=a.forwardRef((function(t,e){var n=t.components,i=t.mdxType,r=t.originalType,d=t.parentName,c=o(t,["components","mdxType","originalType","parentName"]),l=u(n),g=i,h=l["".concat(d,".").concat(g)]||l[g]||p[g]||r;return n?a.createElement(h,s(s({ref:e},c),{},{components:n})):a.createElement(h,s({ref:e},c))}));function h(t,e){var n=arguments,i=e&&e.mdxType;if("string"==typeof t||i){var r=n.length,s=new Array(r);s[0]=g;var o={};for(var d in e)hasOwnProperty.call(e,d)&&(o[d]=e[d]);o.originalType=t,o[l]="string"==typeof t?t:i,s[1]=o;for(var u=2;u<r;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},982:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>d,contentTitle:()=>s,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>u});var a=n(7462),i=(n(7294),n(3905));const r={slug:"bit-packing",title:"Solidity - Bit Packing",authors:{name:"Rahul Saxena",title:"EVM Enjoyoor",url:"https://twitter.com/saxenism",image_url:"https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg"},tags:["web3","solidity","language-tricks","bit-magic","bit-packing","intermediate"]},s="Introduction and Motivation",o={permalink:"/blog/bit-packing",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-10-09-Bit-Packing.md",source:"@site/blog/2022-10-09-Bit-Packing.md",title:"Solidity - Bit Packing",description:"My last blog post about Bit Magic generated some buzz amongst fellow EVM developers and some of them reached out to me to include additional things in my blog related to using bits effectively in Solidity and the EVM in general.",date:"2022-10-09T00:00:00.000Z",formattedDate:"October 9, 2022",tags:[{label:"web3",permalink:"/blog/tags/web-3"},{label:"solidity",permalink:"/blog/tags/solidity"},{label:"language-tricks",permalink:"/blog/tags/language-tricks"},{label:"bit-magic",permalink:"/blog/tags/bit-magic"},{label:"bit-packing",permalink:"/blog/tags/bit-packing"},{label:"intermediate",permalink:"/blog/tags/intermediate"}],readingTime:6.59,hasTruncateMarker:!0,authors:[{name:"Rahul Saxena",title:"EVM Enjoyoor",url:"https://twitter.com/saxenism",image_url:"https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg",imageURL:"https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg"}],frontMatter:{slug:"bit-packing",title:"Solidity - Bit Packing",authors:{name:"Rahul Saxena",title:"EVM Enjoyoor",url:"https://twitter.com/saxenism",image_url:"https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg",imageURL:"https://pbs.twimg.com/profile_images/1554486619914117126/7QV7CHum_400x400.jpg"},tags:["web3","solidity","language-tricks","bit-magic","bit-packing","intermediate"]},nextItem:{title:"Solidity - Passing functions as parameters",permalink:"/blog/functions-as-params"}},d={authorsImageUrls:[void 0]},u=[],c={toc:u},l="wrapper";function p(t){let{components:e,...n}=t;return(0,i.kt)(l,(0,a.Z)({},c,n,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"My last blog post about ",(0,i.kt)("a",{parentName:"p",href:"https://saxenism.com/web3/solidity/language-tricks/bit-magic/intermediate/2022/09/06/Bit-Magic-Solidity.html"},"Bit Magic")," generated some buzz amongst fellow EVM developers and some of them reached out to me to include additional things in my blog related to using bits effectively in Solidity and the EVM in general."),(0,i.kt)("p",null,"One such dev was the giga-chad maintainer of ERC721A himself, ",(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/optimizoor"},"Vectorized.eth")," and he shared ",(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/optimizoor/status/1526015118479200256"},"a tweet")," with me where he showed a few code snippets where some really cool things were going on."),(0,i.kt)("p",null,"Unfortunately, I could not make much sense out of it from the snippets and I had to head over to the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/chiru-labs/ERC721A/pull/272"},"ERC721A pull request")," that was behind the tweet and at that time my world turned upside down."),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/chiru-labs"},"Chiru Labs")," team had written some incredible code and while I have not (yet) figured everything happening in the contract, I did understand that the essence of the contract/PR was to use ",(0,i.kt)("em",{parentName:"p"},"uint packing")," instead of ",(0,i.kt)("em",{parentName:"p"},"structs"),"."),(0,i.kt)("p",null,"So, I set out to write some code for myself and figure out how struct can be packed into uints and see if that could lead to any gas savings. So, let me present my finding."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Spoiler Alert")," ",(0,i.kt)("br",null),"\nYes, it was possible. ",(0,i.kt)("br",null),"\nYes, it did save gas. ",(0,i.kt)("br",null),"\nYes, I did love it. ",(0,i.kt)("br",null)),(0,i.kt)("h1",{id:"pitfalls"},"Pitfalls"),(0,i.kt)("p",null,"First of all, to proceed ahead with this article, you need to know what the ",(0,i.kt)("em",{parentName:"p"},"left shift operator")," is, what the ",(0,i.kt)("em",{parentName:"p"},"right shift operator")," and what is it that they do. Apart from that, you should also understand bitwise operations such as ",(0,i.kt)("inlineCode",{parentName:"p"},"&")," , ",(0,i.kt)("inlineCode",{parentName:"p"},"|"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"~")," ,etc."),(0,i.kt)("p",null,"A good place to learn these concepts or revisit them is ",(0,i.kt)("a",{parentName:"p",href:"https://www.geeksforgeeks.org/bitwise-operators-in-c-cpp/"},"this gfg blog"),"."),(0,i.kt)("p",null,"Next is the biggest pitfall of all. This is where I tripped hard and my mind almost broke (since I could not make sense of the ERC721A contract). Since, most of us might have native languages where we read that language from left to right you would naturally expect Solidity to also have the first stored data on the leftmost end and last saved data on the rightmost end. "),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"BUT BUT BUT")),(0,i.kt)("p",null,"That is not the case. Basically, if you were to store four numbers A,B,C and D in that order, inside of a word you would expect that word to look like this: ","[A,B,C,D]"," but they would be stored as ","[D,C,B,A]",". "),(0,i.kt)("p",null,"(Slightly relevant: ) A good primer about Endianess can be found in ",(0,i.kt)("a",{parentName:"p",href:"https://www.freecodecamp.org/news/what-is-endianness-big-endian-vs-little-endian/"},"this freecodecamp article"),"."),(0,i.kt)("p",null,"Let me illustrate this point with ",(0,i.kt)("a",{parentName:"p",href:"https://gateway.pinata.cloud/ipfs/QmZvGzhf9o6j837xF7eYLnufEACDa2MEvG8qh9TRz3k7bv"},"a picture"),":"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/32522659/194752317-bfb99eeb-f452-4991-99ff-df6c6b9ba102.jpeg",alt:"Big/Little Endian Explanation"})),(0,i.kt)("h1",{id:"onto-the-code"},"Onto the code"),(0,i.kt)("p",null,"Now that we have established our motivation, our objectives and are aware of the common pitfalls, time to relish the sweet code that we all had been waiting for."),(0,i.kt)("p",null,"The code is pretty self-explainatory and comments are put where needed. No more explanation is required."),(0,i.kt)("p",null,"Also, the Harry Potter theme of this contract was inspired by a ",(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/longestwavelen/status/1578620950479659008?s=20&t=u42okhhEbNKXrWgyorA8NA"},"silly tweet"),". Lol :P"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-solidity"},'\n// SPDX-License-Identifier: Unlicensed\n\n/*******\n    // Here are some addresses that you can use for dry-run if you want to the run the contract in Remix.\n        address public SiriusBlack = 0xdD870fA1b7C4700F2BD7f44238821C26f7392148; \n        address public RubeusHagrid = 0x14723A09ACff6D2A60DcdF7aA4AFf308FDDC160C;\n        address public BellatrixLestrange = 0x4B0897b0513fdC7C541B6d9D7E929C4e5364D2dB;\n        address public SeverusSnape = 0x583031D1113aD414F02576BD6afaBfb302140225;\n********/\n\npragma solidity 0.8.17;\n\ncontract BitPackingAlpha {\n\n////////////////////////////////////////////////////////////////////////////////\n// A little definitions here and there so the meat of our code looks slick\n////////////////////////////////////////////////////////////////////////////////\n\n    uint private constant POTIONS_POSITION = 64;\n    uint private constant TRANSFIGURATION_POSITION = 128;\n    uint private constant CARE_OF_MAGICAL_CREATURES_POSITION = 192;\n\n    uint private constant SINGLE_SUBJECT_MASK = (1 << 64) - 1;\n    uint private constant MASK_EVERYTHING_BUT_CARE_OF_MAGICAL_CREATURES = (1 << 192) - 1;\n    \n    address serDumbledore;\n\n    constructor() {\n        serDumbledore = msg.sender;\n    }\n\n    // These separate mappings are to separate the effect of calling normal functions and bit magic functions\n    mapping (address => bool) private _studentGraded;\n    mapping (address => bool) private _studentGradedBitMagic;\n\n    mapping (address => ScoreCard) private results;\n    mapping (address => uint256) private bitMagicResults;\n\n    // Only Dumbledore can grade students\n    modifier onlyHeadmaster() {\n        require(msg.sender == serDumbledore, "Only the headmaster can do this action");\n        _;\n    }\n\n    // The students can only be graded once\n    modifier graded(address _student) {\n        require(!_studentGraded[_student], "Student has already been graded");\n        _;\n    }\n\n    modifier gradedBitMagic(address _student) {\n        require(!_studentGradedBitMagic[_student], "Student has already been graded");\n        _;\n    }\n\n/////////////////////////////////////////////////////////////////////////////////////////\n// This is how we would (and probably should) do things normally. The way of the normie.\n/////////////////////////////////////////////////////////////////////////////////////////\n\n    // Each of these subjects can only be graded from 0 to 100.\n    struct ScoreCard {\n        uint defenceAgainstTheDarkArts;\n        uint potions;\n        uint transfiguration;\n        uint careOfMagicalCreatures;\n    }\n\n    // Execution Cost: 139811\n    // The grades for each of the four subjects are generated randomly and then stored in the *results* mapping against the address of the particular _student\n    function gradeStudents(address _student) public onlyHeadmaster graded(_student) {\n        uint datda_score = uint(keccak256(abi.encodePacked(_student, "defenceAgainstTheDarkArts", block.difficulty, block.timestamp))) % 100;\n        uint potions_score = uint(keccak256(abi.encodePacked(_student, "potions", block.difficulty, block.timestamp))) % 100;\n        uint transfiguration_score = uint(keccak256(abi.encodePacked(_student, "transfiguration", block.difficulty, block.timestamp))) % 100;\n        uint comc_score = uint(keccak256(abi.encodePacked(_student, "careOfMagicalCreatures", block.difficulty, block.timestamp))) % 100;\n        \n        results[_student] = ScoreCard(datda_score, potions_score, transfiguration_score, comc_score);\n\n        _studentGraded[_student] = true;\n    }\n\n    // Execution Cost: 31229\n    // Grab the results of student with address _student\n    function getStudentResults(address _student) external view returns(uint, uint, uint, uint) {\n        return (\n            results[_student].defenceAgainstTheDarkArts, \n            results[_student].potions,\n            results[_student].transfiguration,\n            results[_student].careOfMagicalCreatures\n        );\n    }\n\n//////////////////////////////////////////////////////////////////////////////////////////////////////\n// Let\'s try some bit magic now. The way of the Bit Magician (Frankly it\'s just bit packing. Nothing fancy :P)\n//////////////////////////////////////////////////////////////////////////////////////////////////////\n\n    // Takes four 8 bytes uints and pack it into a single uint256 \n    // Initialize a number `packedMarksUint` which has 256 0\'s\n    // Take the number that you want to pack, shift it to its required place(0th bit, 64th bit, 128th bit or the 192nd bit) and do an OR with the 64 0\'s at that place of the `packedMarksUint` uint.\n    function packMarksIntoASingleUint(uint a, uint b, uint c, uint d) private pure returns (uint packedResult) {\n        uint packedMarksUint;\n\n        packedMarksUint = packedMarksUint | uint64(a); // This stores the Defence Against the Dark Arts grades\n        packedMarksUint = packedMarksUint | (b << POTIONS_POSITION); // This stores the Potions grade\n        packedMarksUint = packedMarksUint | (c << TRANSFIGURATION_POSITION); // This stores the Transfiguration grades\n        packedMarksUint = (packedMarksUint & MASK_EVERYTHING_BUT_CARE_OF_MAGICAL_CREATURES) | (d << CARE_OF_MAGICAL_CREATURES_POSITION); // This stores the Care of Magical Creatures grades\n        \n        packedResult = packedMarksUint;\n    }\n\n    // Execution Cost: 25229\n    // Logic is to shift the target number to the leftmost end and then do an *&* with 64 1\'s to reveal that particular number\n    // For the rightmost number, we only need to shift it to the leftmost position and cast it to uint64. That does the same thing.\n    function getStudentResultsBitMagic(address _student) external view returns (uint _datda, uint _potions, uint _transfigurations, uint64 _comc) {\n        _datda = (bitMagicResults[_student] & SINGLE_SUBJECT_MASK);\n        _potions = ((bitMagicResults[_student] >> POTIONS_POSITION) & SINGLE_SUBJECT_MASK);\n        _transfigurations = ((bitMagicResults[_student] >> TRANSFIGURATION_POSITION) & SINGLE_SUBJECT_MASK);\n        _comc = uint64(bitMagicResults[_student] >> CARE_OF_MAGICAL_CREATURES_POSITION);\n    }\n\n    // Execution Cost: 73430 \n    // The grades for each of the four subjects are generated randomly and then stored as a packed uint256 in the *bitMagicResults* mapping against the address of the particular _student\n    function gradeStudentsWithBitMagic(address _student) external onlyHeadmaster gradedBitMagic(_student) {\n        uint datda_score = uint(keccak256(abi.encodePacked(_student, "defenceAgainstTheDarkArts", block.difficulty, block.timestamp))) % 100;\n        uint potions_score = uint(keccak256(abi.encodePacked(_student, "potions", block.difficulty, block.timestamp))) % 100;\n        uint transfiguration_score = uint(keccak256(abi.encodePacked(_student, "transfiguration", block.difficulty, block.timestamp))) % 100;\n        uint comc_score = uint(keccak256(abi.encodePacked(_student, "careOfMagicalCreatures", block.difficulty, block.timestamp))) % 100;\n        \n        bitMagicResults[_student] = packMarksIntoASingleUint(datda_score, potions_score, transfiguration_score, comc_score);\n        _studentGradedBitMagic[_student] = true;\n    }\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////\n// Viewing individual grades (I simply combined all these function logics in the function getStudentResultsBitMagic)\n/////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n    function bitMagicGetDefenceAgainstTheDarkArtsGrades(address _student) external view returns (uint) {\n        return (bitMagicResults[_student] & ((1 << 64) - 1));\n    }\n\n    function bitMagicGetCareOfMagicalCreaturesGrades(address _student) external view returns (uint64) {\n        return uint64(bitMagicResults[_student] >> CARE_OF_MAGICAL_CREATURES_POSITION);\n    }\n\n    function bitMagicGetPotionsGrades(address _student) external view returns (uint) {\n        return ((bitMagicResults[_student] >> POTIONS_POSITION) & SINGLE_SUBJECT_MASK);\n    }\n\n    function bitMagicGetTransfigurationGrades(address _student) external view returns (uint) {\n        return ((bitMagicResults[_student] >> TRANSFIGURATION_POSITION) & SINGLE_SUBJECT_MASK);\n    }\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////\n// Viewing individual grades: The normie way\n/////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n    function getDefenceAgainstTheDarkArtsGrades(address _student) external view returns (uint) {\n        return results[_student].defenceAgainstTheDarkArts;\n    }\n\n    function getPotionsGrades(address _student) external view returns (uint) {\n        return results[_student].potions;\n    }\n\n    function getTransfigurationGrades(address _student) external view returns (uint) {\n        return results[_student].transfiguration;\n    }\n\n    function getCareOfMagicalCreaturesGrades(address _student) external view returns (uint) {\n        return results[_student].careOfMagicalCreatures;\n    }\n\n}\n\n')))}p.isMDXComponent=!0}}]);