<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Solidity Contract Proxies | EVM Expressions</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Solidity Contract Proxies" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Everything you need to know about upgrading your smart contracts" />
<meta property="og:description" content="Everything you need to know about upgrading your smart contracts" />
<link rel="canonical" href="https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html" />
<meta property="og:url" content="https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html" />
<meta property="og:site_name" content="EVM Expressions" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-30T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Solidity Contract Proxies" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-30T00:00:00-05:00","datePublished":"2022-04-30T00:00:00-05:00","description":"Everything you need to know about upgrading your smart contracts","headline":"Solidity Contract Proxies","mainEntityOfPage":{"@type":"WebPage","@id":"https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html"},"url":"https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://saxenism.com/feed.xml" title="EVM Expressions" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NCLWFTBNXB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NCLWFTBNXB');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">EVM Expressions</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a><a class="page-link" href="/videos/">Videso</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Solidity Contract Proxies</h1><p class="page-description">Everything you need to know about upgrading your smart contracts</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-04-30T00:00:00-05:00" itemprop="datePublished">
        Apr 30, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#web3">web3</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#solidity">solidity</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#security">security</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#proxy">proxy</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#upgradation">upgradation</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#migration-or-social-yeet-ct-lingo">Migration or Social Yeet (CT Lingo)</a></li>
<li class="toc-entry toc-h1"><a href="#proxies">Proxies</a>
<ul>
<li class="toc-entry toc-h2"><a href="#proxy-terminologies">Proxy Terminologies</a></li>
<li class="toc-entry toc-h2"><a href="#storage-variables">Storage Variables</a></li>
<li class="toc-entry toc-h2"><a href="#issues-with-proxies">Issues with proxies</a>
<ul>
<li class="toc-entry toc-h3"><a href="#1-storage-clashes">1. Storage Clashes</a></li>
<li class="toc-entry toc-h3"><a href="#2-function-selector-clashes">2. Function Selector Clashes</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#proxy-patterns">Proxy Patterns</a>
<ul>
<li class="toc-entry toc-h3"><a href="#1-transparent-proxy-pattern">1. Transparent Proxy Pattern</a></li>
<li class="toc-entry toc-h3"><a href="#2-universal-upgradable-proxies">2. Universal Upgradable Proxies</a></li>
<li class="toc-entry toc-h3"><a href="#3-diamond-pattern">3. Diamond Pattern</a></li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="migration-or-social-yeet-ct-lingo">
<a class="anchor" href="#migration-or-social-yeet-ct-lingo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Migration or Social Yeet (CT Lingo)</h1>

<p>You keep all your deployed contracts immutable and non-upgradable. So, when you actually need to modify your deployed contract’s logic or add some functionality, you have to deploy a new contract and ask the users to start making their calls to this newly deployed version of your protocol’s smart
contract address.</p>

<p>This is the truest form of upgrading your contracts, without compromising on the trustless (no onlyAdmin functions) and decentralisation facets of web3. However, as is amply clear pulling this type of an upgrade isn’t really a breeze.</p>

<h1 id="proxies">
<a class="anchor" href="#proxies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Proxies</h1>

<h2 id="proxy-terminologies">
<a class="anchor" href="#proxy-terminologies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Proxy Terminologies</h2>

<ol>
  <li>The Implementation Contract
    <ul>
      <li>Which has all our code of our protocol. When we upgrade, we launch a brand new implementation contract.</li>
    </ul>
  </li>
  <li>The Proxy Contract
    <ul>
      <li>Which points to which implementation is the “correct” one, and routes everyone’s function calls to that contract</li>
    </ul>
  </li>
  <li>The User
    <ul>
      <li>The make calls to the proxy</li>
    </ul>
  </li>
  <li>The admin
    <ul>
      <li>This is the user(or group of users/voters) who upgrade to new implementation contracts.</li>
    </ul>
  </li>
</ol>

<h2 id="storage-variables">
<a class="anchor" href="#storage-variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>Storage Variables</h2>

<p>The cool thing about proxies and delegate call is that all our storage variables are going to be stored in the proxy contract and not in the implementation contract. Therefore, when you deploy a new contract and your proxy starts pointing to this new contract, you don’t have to migrate the data from the old contract as it is already in the proxy contract.</p>

<h2 id="issues-with-proxies">
<a class="anchor" href="#issues-with-proxies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Issues with proxies</h2>

<h3 id="1-storage-clashes">
<a class="anchor" href="#1-storage-clashes" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Storage Clashes</h3>

<p>When we do <code class="language-plaintext highlighter-rouge">delegateCall</code> from the proxyContract, we do the logic of implementationContract inside the proxyContract.</p>

<p>In Solidity storage layout begins at position 0 and increments for each new state variable. A proxy contract and its delegate/logic contracts share the same storage layout!</p>

<p>Here is an example to illustrate the problem. ProxyA defines two state variables, facetA and owner .</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>contract ProxyA {
  address facetA;  
  address owner;
  constructor() public {
    owner = msg.sender;
    facetA = 0x0b22380B7c423470979AC3eD7d3c07696773dEa1;
  }
  fallback() external payable {
    address facetAddress = facetA;
    assembly {
      ... code omitted for simplicity
    }
  }
}
</code></pre></div></div>

<p>FacetA declares one state variable.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>contract FacetA {
  address user;
  function getUser() external view returns(address) {
    return user;
  }
  function setUser(address newUser) external {
    user = newUser;
  }
}
</code></pre></div></div>

<p>ProxyA delegates function calls to FacetA. The problem is that, when delegating, ProxyA and FacetA share the same storage layout. The state variable facetA is at position 0. And The state variable user is also at position 0. So if the setUser function is called it will set user and facetA to the newUser value, which is obviously not the intention, the intention just being to set user only.</p>

<p>So, basically, you can only ever append variables to your implementation contract and not really change or re-order the old ones.</p>

<p>Now,ideally if you called <code class="language-plaintext highlighter-rouge">setValue</code> using delegateCall from your proxy contract, it should set the value of <code class="language-plaintext highlighter-rouge">differentValue</code> but it sets the value</p>

<h3 id="2-function-selector-clashes">
<a class="anchor" href="#2-function-selector-clashes" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Function Selector Clashes</h3>

<p>Function Selector: A 4 byte hash of a function name and function signature that define a function.</p>

<p>Now it is possible that a function in the implementation contract has the same function selector as an admin function in the proxy contract. Think of a scenario where <code class="language-plaintext highlighter-rouge">function getPrice</code> in the implementationContract has the same Function Selector as <code class="language-plaintext highlighter-rouge">function destroyProxy</code>. Definitely would not be good.</p>

<p>For example, the following two functions have the exact same function selector</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> function collate_propagate_storage(bytes16) external{}
 function burn(uint256) external {}
</code></pre></div></div>

<p>Contract to verify this statement is as follows and also can be found on this link: https://gist.github.com/saxenism/02af4e7a7fdb42801157571a3dab2c05</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// SPDX-License-Identifier: MIT

pragma solidity &gt;=0.7.0 &lt;0.9.0;

contract ProxyExperimentation {

    function getFunctionSignature(string memory signature) internal pure returns (bytes4) {
        return bytes4(keccak256(bytes(signature)));
    }

    function checkFunctionSelectorSimilarity() external pure returns (bool) {
        bytes4 functionSelector1 = getFunctionSignature("collate_propagate_storage(bytes16)");
        bytes4 functionSelector2 = getFunctionSignature("burn(uint256)");

        bool success = (functionSelector1 == functionSelector2);
        return success;
    }

    function verifyOtherFunctionDisimilarity() external pure returns (bool) {
        bytes4 functionSelector1 = getFunctionSignature("collate_propagate_storage(bytes16)");
        bytes4 functionSelector2 = getFunctionSignature("burnn(uint256)");

        bool result = (functionSelector1 == functionSelector2);
        return result;
    }
}
</code></pre></div></div>
<h2 id="proxy-patterns">
<a class="anchor" href="#proxy-patterns" aria-hidden="true"><span class="octicon octicon-link"></span></a>Proxy Patterns</h2>

<h3 id="1-transparent-proxy-pattern">
<a class="anchor" href="#1-transparent-proxy-pattern" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Transparent Proxy Pattern</h3>

<p>In this pattern, the admin can call only call the admin functions in the proxy contract and the users can only call the functions in the implementation contract. Admin functions are the functions that govern the upgrades.</p>

<p>This way, as an admin or as a user you can’t mix up functions from different contracts with the same function selector and no problems should occur.
As a side note, now the admin cannot participate in their own DeFi protocol :P</p>

<h3 id="2-universal-upgradable-proxies">
<a class="anchor" href="#2-universal-upgradable-proxies" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Universal Upgradable Proxies</h3>

<p>Admin Only functions are kept in the implementation contract itself, instead of the proxy.</p>

<p>The advantage here is, if that happens, and two functions have the same function selector, then the Solidity compiler will let us know.
Also, since there is one less read that we have to do, we save on gas costs.</p>

<p>So, it is necessary here that you implement the upgradation functions in the implementation contract, because otherwise you would be stuck and we get back to the YEET method</p>

<h3 id="3-diamond-pattern">
<a class="anchor" href="#3-diamond-pattern" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Diamond Pattern</h3>

<p>Allows for multiple implementation contracts. Is probably the best method to implement upgradable contracts, since it allows you to make granular changes/upgrades, but it can get really complex. So to use this, you need to be really really good at smart contract development.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="saxenism/saxenism-expressions"
        issue-term="title"
        label="blogpost-comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html';
      this.page.identifier = 'https://saxenism.com/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/web3/solidity/security/proxy/upgradation/2022/04/30/All-About-Proxies.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Personal website of Rahul Saxena, containing his thoughts about web3, EVM and a decentralised world.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://feedrabbit.com/subscriptions/new?url=https%3A%2F%2Fsaxenism.com%2F" target="_blank" title="rss">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/saxenism" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/saxenism" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/saxena-rahul/" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
