<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">WIP -&gt; Everything about Reentrancy Attacks</h1><p class="page-description">With credits to the excellent re-entrancy repository by pcaversaccio, this article is an attempt to provide a summary of the attacks.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-12-02T00:00:00-06:00" itemprop="datePublished">
        Dec 2, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#web3">web3</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#solidity">solidity</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#exploits">exploits</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#advanced">advanced</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#intermediate">intermediate</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#wip">WIP</a></li>
<li class="toc-entry toc-h1"><a href="#introduction-and-motivation">Introduction and Motivation</a>
<ul>
<li class="toc-entry toc-h2"><a href="#note-about-the-attacks-covered">Note about the attacks covered</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#imbtc-uniswap-pool-attack">imBTC Uniswap Pool Attack</a>
<ul>
<li class="toc-entry toc-h2"><a href="#relevant-links">Relevant Links</a></li>
<li class="toc-entry toc-h2"><a href="#background">Background</a>
<ul>
<li class="toc-entry toc-h3"><a href="#tokelon">Tokelon</a></li>
<li class="toc-entry toc-h3"><a href="#imbtc">imBTC</a></li>
<li class="toc-entry toc-h3"><a href="#erc777-standard">ERC777 standard</a>
<ul>
<li class="toc-entry toc-h4"><a href="#relevant-links-1">Relevant Links</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#the-issue-with-erc777-tokens">The issue with ERC777 tokens</a></li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="wip">
<a class="anchor" href="#wip" aria-hidden="true"><span class="octicon octicon-link"></span></a>WIP</h1>

<p>This post is a work in progress and not complete. Stay tuned for weekly updates.</p>

<h1 id="introduction-and-motivation">
<a class="anchor" href="#introduction-and-motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction and Motivation</h1>

<p>// Write Introduction and Motivation</p>

<h2 id="note-about-the-attacks-covered">
<a class="anchor" href="#note-about-the-attacks-covered" aria-hidden="true"><span class="octicon octicon-link"></span></a>Note about the attacks covered</h2>

<p>I’ll only be covering re-entrancy attacks from 2020 onwards as I consider them recent and should be put out in the public domain in an easily digestable format for the long term safety of DeFi users and the eventual mass adoption of DeFi.</p>

<h1 id="imbtc-uniswap-pool-attack">
<a class="anchor" href="#imbtc-uniswap-pool-attack" aria-hidden="true"><span class="octicon octicon-link"></span></a>imBTC Uniswap Pool Attack</h1>

<h2 id="relevant-links">
<a class="anchor" href="#relevant-links" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relevant Links</h2>

<ol>
  <li><a href="https://etherscan.io/address/0xFFcf45b540e6C9F094Ae656D2e34aD11cdfdb187">Victim Contract</a></li>
  <li><a href="https://etherscan.io/address/0xBD2250D713bf98b7E00c26E2907370aD30f0891a">Exploit Contract</a></li>
  <li><a href="https://etherscan.io/tx/0x9437dde6c06a20f6d56f69b07f43d5fb918e6c57c97e1fc25a4162c693f578aa">Exploit Transaction</a></li>
  <li><a href="https://defirate.com/news/imbtc-uniswap-hack">Media Coverage</a></li>
</ol>

<h2 id="background">
<a class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h2>

<p>This section contains the context that you need to have before we jump in to inspect the attack.</p>

<p>Also, all the information in this section is being taken off the internet as of 2nd December 2022. Therefore, it <em>might</em> not be the same as the information at the time of attack.</p>

<h3 id="tokelon">
<a class="anchor" href="#tokelon" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tokelon</h3>

<p><a href="https://tokenlon.im/">Tokelon</a> is a decentralised exchange (DEX) protocol that provides a <a href="https://tokenlon.im/imbtc">Bitcoin Wrapping Service</a>, and thus providing a coin called <strong>imBTC</strong> to the markets.</p>

<h3 id="imbtc">
<a class="anchor" href="#imbtc" aria-hidden="true"><span class="octicon octicon-link"></span></a>imBTC</h3>

<ol>
  <li>imBTC is an ERC777 token, issued and regulated by Tokenlon.</li>
  <li>It is backed 1:1 with Bitcoin and holders can mint, exchange and redeem their imBTC for equivalent amount of BTC</li>
  <li>imBTC can be bought with BTC(from the imBTC DApp) or ERC20 tokens such as USDC or ETH.</li>
  <li>You get interest by holding imBTC (generated from Tokenlon’s imBTC exchange fee).</li>
  <li>(The actual unwrapped) BTC will be stored in Tokenlon’s cold wallet, and the <mark>cold wallet will ensure the security of BTC</mark> assets.</li>
  <li>Anyone who has imBTC <mark>can trigger the function of distributing imBTC revenue</mark>. All income will be allocated to users wallet in the proportion to imBTC.</li>
</ol>

<p>Hmm, with point 6 they are following the pull mechanism instead of push for fund distribution which is good, security wise.</p>

<h3 id="erc777-standard">
<a class="anchor" href="#erc777-standard" aria-hidden="true"><span class="octicon octicon-link"></span></a>ERC777 standard</h3>

<ul>
  <li>This is a standard for generating tokens in the Ethereum Blockchain.</li>
  <li>This is backwards compatible with ERC20, which means, you can interact with these tokens as if they were ERC20, using the standard functions, while still getting all of the niceties, including send hooks.</li>
  <li>Ether compliant interface in the sense that you can use the <code class="language-plaintext highlighter-rouge">send</code> function to transfer ERC777 tokens much like how you transfer Ether.</li>
  <li>This standard introduces something called <strong>hooks</strong>, to counter the issues with ERC20.
    <ul>
      <li>A hook is simply a function in a contract that is called when tokens are sent to it, meaning accounts and contracts can react to receiving tokens.</li>
      <li>The hooks are registered and discovered using the <a href="https://eips.ethereum.org/EIPS/eip-1820">ERC-1820 standard</a>.</li>
      <li>Hooks allow sending tokens to a contract and notifying the contract in a single transaction, unlike ERC-20, which requires a double call (approve/transferFrom) to achieve this.</li>
      <li>Hooks can reject transactions.</li>
      <li>Token transfers to other contracts may revert with the following message: <code class="language-plaintext highlighter-rouge">ERC777: token recipient contract has no implementer for ERC777TokensRecipient</code>. This is good since this reflects that fact that whatever contract you were trying to send the tokens to, was not aware of the ERC777 standard and hence we can avoid tokens from being locked forever with this.</li>
      <li>As an example, the Golem contract currently holds over 350k GNT tokens, worth multiple tens of thousands of dollars, and lacks methods to get them out of there. This has happened to virtually every ERC20-backed project, usually due to user error.</li>
    </ul>
  </li>
  <li>The token holder can “authorize” and “revoke” operators who can manage their tokens. These operators generally are going to be verified contracts like an exchange, a cheque processor or an automatic charging system.</li>
  <li>Every token transaction contains a userData bytes field and a similar operatorData – in case of an operator transaction – to be used freely by the user (sender) and the operator respectively to pass data to the recipient.</li>
</ul>

<h4 id="relevant-links-1">
<a class="anchor" href="#relevant-links-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relevant Links</h4>

<ol>
  <li><a href="https://eips.ethereum.org/EIPS/eip-777">Official EIP 777</a></li>
  <li><a href="https://medium.com/coinmonks/erc-777-a-new-advanced-token-standard-c841788ab3cb">In-depth Primer on ERC777</a></li>
  <li><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2620">Discussions around the safety of this standard</a></li>
</ol>

<h3 id="the-issue-with-erc777-tokens">
<a class="anchor" href="#the-issue-with-erc777-tokens" aria-hidden="true"><span class="octicon octicon-link"></span></a>The issue with ERC777 tokens</h3>

<p>Everyone of us can agree that Bitcoin is <em>safer</em> than Ethereum, right? Well, yes, and that is because Bitcoin is much more limited in the scope of what is possible with it than Ethereum. The same is the case with ERC777. The standard in and of itself is not bad, rather one can argue that it’s really cool. But since using this standard is non-trivial and the developer is required to pay attention to slightly more details than a normal ERC20 token, the surface area for this standard to get attacked also increases.</p>

<p>And one such attack vector led to our <code class="language-plaintext highlighter-rouge">imBTC Uniswap Pool Attack</code>.</p>

<p>In Uniswap’s audit by Consensys, they explained in some detail how it will be possible to drain a pool using the ERC777 token standard if the token allowed re-entrancy on <code class="language-plaintext highlighter-rouge">transferFrom(address from, address to, uint tokens)</code> function by someone except the recipient.</p>

<p>The link to the detailed vulnerability report can be found <a href="https://github.com/ConsenSys/Uniswap-audit-report-2018-12#31-liquidity-pool-can-be-stolen-in-some-tokens-eg-erc-777-29">here</a>.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="saxenism/saxenism-expressions"
        issue-term="title"
        label="blogpost-comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://saxenism.com/web3/solidity/exploits/advanced/intermediate/2022/12/02/Reentrancy-Deep-Dive.html';
      this.page.identifier = 'https://saxenism.com/web3/solidity/exploits/advanced/intermediate/2022/12/02/Reentrancy-Deep-Dive.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/web3/solidity/exploits/advanced/intermediate/2022/12/02/Reentrancy-Deep-Dive.html" hidden></a>
</article>
